<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Control and Status Registers - Writing a RISC-V Emulator in Rust</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="Writing a RISC-V emulator in Rust to aim to run xv6, a small Unix-like OS.">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="../favicon.svg">
        
        
        <link rel="shortcut icon" href="../favicon.png">
        
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        
        <link rel="stylesheet" href="../css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
        <link rel="stylesheet" href="../theme/custom.css">
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "coal" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../index.html">Writing a RISC-V Emulator in Rust</a></li><li class="chapter-item expanded "><a href="../hardware-components/index.html"><strong aria-hidden="true">1.</strong> Hardware Components</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../hardware-components/01-cpu.html"><strong aria-hidden="true">1.1.</strong> CPU with Two Instructions</a></li><li class="chapter-item expanded "><a href="../hardware-components/02-memory.html"><strong aria-hidden="true">1.2.</strong> Memory and System Bus</a></li><li class="chapter-item expanded "><a href="../hardware-components/03-csrs.html" class="active"><strong aria-hidden="true">1.3.</strong> Control and Status Registers</a></li></ol></li><li class="chapter-item expanded "><a href="../instruction-set/index.html"><strong aria-hidden="true">2.</strong> Instruction Set</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../instruction-set/01-rv64i.html"><strong aria-hidden="true">2.1.</strong> RV64I Base Integer Instruction Set</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Writing a RISC-V Emulator in Rust</h1>

                    <div class="right-buttons">
                        
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#control-and-status-registers" id="control-and-status-registers">Control and Status Registers</a></h1>
<p>This is a part of <a href="../"><em>Writing a RISC-V Emulator in Rust</em></a>. Our goal is
running <a href="https://github.com/mit-pdos/xv6-riscv">xv6</a>, a small Unix-like OS, in
your emulator eventually.</p>
<p>The source code used in this page is available at
<a href="https://github.com/d0iasm/rvemu-for-book/tree/master/03">d0iasm/rvemu-for-book/03/</a>.</p>
<h2><a class="header" href="#the-goal-of-this-page" id="the-goal-of-this-page">The Goal of This Page</a></h2>
<p>In this page, we will implement read-and-modify control and status registers
(CSRs), which are defined at the Zicsr extension. CSRs are registers that store
additional information of the result of instructions.</p>
<p>We will add Zicsr instructions, <code>csrrw</code>, <code>csrrs</code>, <code>csrrc</code>, <code>csrrwi</code>, <code>csrrsi</code>,
and <code>csrrci</code>, to read and write CSRs.</p>
<h2><a class="header" href="#control-and-status-registers-csrs" id="control-and-status-registers-csrs">Control and Status Registers (CSRs)</a></h2>
<p>Control and status register (CSR) is a register that stores various information
in CPU. RISC-V defines a separate address space of 4096 CSRs so we can have at
most 4096 CSRs. RISC-V only allocates a part of address space so we can add
custom CSRs in unused addresses. Also, not all CSRs are required on all
implementations.</p>
<p>Fig 3.1-3.3 list the machine-level and supervisor CSRs that are currently
allocated CSR addresses. The next page will talk about what machine-level
(M-mode) and supervisor-level (S-mode) are.</p>
<p>We will support a part of the allocated CSRs used in
<a href="https://github.com/mit-pdos/xv6-riscv">xv6-riscv</a>. The book only describes
them in the following sections.</p>
<p><img src="../img/1-3-1.png" alt="Fig 3.1 Machine-level CSRs 1 (Source: Table 2.5: Currently allocated RISC-V machine-level CSR addresses. in Volume II: Privileged Architecture)" /></p>
<p class="caption">Fig 3.1 Machine-level CSRs 1 (Source: Table 2.5: Currently
allocated RISC-V machine-level CSR addresses. in Volume II: Privileged
Architecture)</p>
<p><img src="../img/1-3-2.png" alt="Fig 3.2 Machine-level CSRs 2 (Source: Table 2.6: Currently allocated RISC-V machine-level CSR addresses. in Volume II: Privileged Architecture)" /></p>
<p class="caption">Fig 3.2 Machine-level CSRs 2 (Source: Table 2.6: Currently
allocated RISC-V machine-level CSR addresses. in Volume II: Privileged
Architecture)</p>
<p><img src="../img/1-3-3.png" alt="Fig 3.3 Supervisor-level CSRs (Source: Table 2.3: Currently allocated RISC-V supervisor-level CSR addresses. in Volume II: Privileged Architecture)" /></p>
<p class="caption">Fig 3.3 Supervisor-level CSRs (Source: Table 2.3: Currently
allocated RISC-V supervisor-level CSR addresses. in Volume II: Privileged
Architecture)</p>
<h3><a class="header" href="#status-registers-mstatussstatus" id="status-registers-mstatussstatus">Status Registers (mstatus/sstatus)</a></h3>
<p>The status registers, <code>mstatus</code> for M-mode and <code>sstatus</code> for S-mode, keep track
of and control the CPU's current operating status.</p>
<p><code>mstatus</code> is allocated at <code>0x300</code> and <code>sstatus</code> is allocated at <code>0x100</code>. It
means we can access status registers by <code>0x300</code> and <code>0x100</code>.</p>
<p>Fig 3.4 and Fig 3.5 represent the format of <code>mstatus</code> and <code>sstatus</code>. The length
of these regsiters is 64. Each bit is allocated to a different meaning and we
can tell the status to the CPU by setting/unsetting bits.</p>
<p>A restricted view of <code>mstatus</code> appears as the `sstatusw register.</p>
<p><img src="../img/1-3-4.png" alt="Fig 3.4 mstatus register (Source: Figure 3.6: Machine-mode status register (mstatus) for RV64. in Volume II: Privileged Architecture)" /></p>
<p class="caption">Fig 3.4 mstatus register (Source: Figure 3.6: Machine-mode
status register (mstatus) for RV64. in Volume II: Privileged Architecture)</p>
<p><img src="../img/1-3-5.png" alt="Fig 3.5 sstatus register (Source: Figure 4.2: Supervisor-mode status register (mstatus) for RV64. in Volume II: Privileged Architecture)" /></p>
<p class="caption">Fig 3.5 sstatus register (Source: Figure 4.2:
Supervisor-mode status register (mstatus) for RV64. in Volume II: Privileged
Architecture)</p>
<p><code>MIE</code> and <code>SIE</code> are global insterrupt bits, <code>M</code> for M-mode and <code>S</code> for S-mode.
When these bits are set, interrupts are globally enabled.</p>
<h3><a class="header" href="#trap-vector-base-address-registers-mtvecstvecc" id="trap-vector-base-address-registers-mtvecstvecc">Trap-vector Base-address Registers (mtvec/stvecc)</a></h3>
<p>The trap-vector base address registers, <code>mtvec</code> for M-mode and <code>stvec</code> for
S-mode, trap vector configuration. <code>mtvec</code> is allocated at <code>0x303</code> and <code>stvec</code>
is allocated at <code>0x105</code>.</p>
<p><img src="../img/1-3-6.png" alt="Fig 3.6 mtvec register (Source: Figure 3.9: Machine trap-vector base-address register (mtvec). in Volume II: Privileged Architecture)" /></p>
<p class="caption">Fig 3.6 mtvec register (Source: Figure 3.9: Machine
trap-vector base-address register (mtvec). in Volume II: Privileged
Architecture)</p>
<p><code>BASE</code> contains the destination address when trap (an exception or an
interrupt) occurs.</p>
<p><code>MODE</code> can add alignment constraints on the value in <code>BASE</code>. When <code>MODE</code> is 0,
the next program counter is set to the value in <code>BASE</code> is used as it is.  When
<code>MODE</code> is 1, the next program counter is set to the value of <code>BASE</code> + 4 ×
<code>cause</code>.  The value of <code>cause</code> can be gotten in trap cause registers.</p>
<h3><a class="header" href="#machine-trap-delegation-registers-medelegmideleg" id="machine-trap-delegation-registers-medelegmideleg">Machine Trap Delegation Registers (medeleg/mideleg)</a></h3>
<p>The trap delegation registers, <code>medeleg</code> for machine-level exception delegation
and <code>mideleg</code> for machine-level interrupt delegation, indicate the certain
exceptions and interrupts should be directly by a lower privileged level.
<code>medeleg</code> is allocated at <code>0x302</code> and <code>mideleg</code> is allocated at <code>0x303</code>.</p>
<p><img src="../img/1-3-7.png" alt="Fig 3.7 medeleg register (Source: Figure 3.10: Machine Exception Delegation Register medeleg. in Volume II: Privileged Architecture)" /></p>
<p class="caption">Fig 3.7 medeleg register (Source: Figure 3.10: Machine Exception Delegation
Register medeleg. in Volume II: Privileged Architecture)</p>
<p><img src="../img/1-3-8.png" alt="Fig 3.8 mideleg register (Source: Figure 3.11: Machine Interrupt Delegation Register mideleg. in Volume II: Privileged Architecture)" /></p>
<p class="caption">Fig 3.8 mideleg register (Source: Figure 3.11: Machine Interrupt Delegation
Register mideleg. in Volume II: Privileged Architecture)</p>
<p>By default, all trap should be handled in M-mode (highest privileged mode).
These registers can delegate a corresponding trap to lower-level privileged mode.</p>
<h3><a class="header" href="#interrupt-registers-mipmiesipsie" id="interrupt-registers-mipmiesipsie">Interrupt Registers (mip/mie/sip/sie)</a></h3>
<p>The interrupt registers, <code>mip</code> and <code>mie</code> for M-mode and <code>sip</code> and <code>sie</code> for
S-mode, contain the information about interrupts. &quot;ip&quot; is the abbreviation of
&quot;Interrupt Pending&quot; and &quot;ie&quot; is &quot;Interrupt Enable&quot;.</p>
<p><code>mip</code> is allocated at <code>0x344</code>, <code>mie</code> is <code>0x304</code>, <code>sip</code> is <code>0x144</code>, and <code>sie</code> is
<code>0x104</code>.</p>
<p><img src="../img/1-3-9.png" alt="Fig 3.9 mip register (Source: Figure 3.12: Machine Interrupt-Pending Register (mip). in Volume II: Privileged Architecture)" /></p>
<p class="caption">Fig 3.9 mip register (Source: Figure 3.12: Machine Interrupt-Pending Register
(mip). in Volume II: Privileged Architecture)</p>
<p><img src="../img/1-3-10.png" alt="Fig 3.10 mie register (Source: Figure 3.13: Machine Interrupt-Enable Register (mie). in Volume II: Privileged Architecture)" /></p>
<p class="caption">Fig 3.10 mie register (Source: Figure 3.13: Machine Interrupt-Enable Register
(mie). in Volume II: Privileged Architecture)</p>
<p><img src="../img/1-3-11.png" alt="Fig 3.11 sip register (Source: Figure 4.4: Supervisor interrupt-pending register (sip). in Volume II: Privileged Architecture)" /></p>
<p class="caption">Fig 3.11 sip register (Source: Figure 4.4: Supervisor interrupt-pending
register (sip). in Volume II: Privileged Architecture)</p>
<p><img src="../img/1-3-12.png" alt="Fig 3.12 sie register (Source: Figure 4.5: Supervisor interrupt-enable register (sie). in Volume II: Privileged Architecture)" /></p>
<p class="caption">Fig 3.12 sie register (Source: Figure 4.5: Supervisor interrupt-enable
register (sie). in Volume II: Privileged Architecture)</p>
<h3><a class="header" href="#exception-program-counters-mepcsepc" id="exception-program-counters-mepcsepc">Exception Program Counters (mepc/sepc)</a></h3>
<h3><a class="header" href="#trap-cause-registers-mcausescause" id="trap-cause-registers-mcausescause">Trap Cause Registers (mcause/scause)</a></h3>
<h3><a class="header" href="#trap-value-registers-mtvalstval" id="trap-value-registers-mtvalstval">Trap Value Registers (mtval/stval)</a></h3>
<h3><a class="header" href="#supervisor-address-translation-and-protection-register-satp" id="supervisor-address-translation-and-protection-register-satp">Supervisor Address Translation and Protection Register (satp)</a></h3>
<h2><a class="header" href="#add-csrs-to-cpu" id="add-csrs-to-cpu">Add CSRs to CPU</a></h2>
<p>First, we're going to add <code>csrs</code> field to <code>Cpu</code> structure. We now have 4 fields
including <code>regs</code>, <code>pc</code>, and <code>bus</code> in CPU.</p>
<p class="filename">cpu.rs</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub struct Cpu {
    pub regs: [u64; 32],
    pub pc: u64,
    /// Control and status registers. RISC-V ISA sets aside a 12-bit encoding
    /// space (csr[11:0]) for up to 4096 CSRs.
    pub csrs: [u64; 4096],
    pub bus: Bus,
}
<span class="boring">}
</span></code></pre></pre>
<h2><a class="header" href="#zicsr-standard-extension" id="zicsr-standard-extension">Zicsr Standard Extension</a></h2>
<p>Fig 3.99 is the list for instructions to read-modify-write CSRs. RISC-V calls
the 6 instructions <strong>Zicsr standard extension</strong>.</p>
<p>A CSR specifier is encoded in the 12-bit <code>csr</code> field of the instruction placed
at 31–20 bits. There are 12 bits for specifying which CSR is selected so that we
have 4096 CSRs (=2**12). The <code>uimm</code> field is unsigned immediate value, a 5-bit
zero-extended.</p>
<p><img src="../img/1-3-99.png" alt="Fig 3.99 RV64Zicsr Instruction Set (Source: RV32/RV64 Zicsr Standard Extension table. in Volume I: Unprivileged ISA)" /></p>
<p class="caption">Fig 3.99 RV64Zicsr Instruction Set (Source: RV32/RV64 Zicsr
Standard Extension table in Volume I: Unprivileged ISA)</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../hardware-components/02-memory.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../instruction-set/index.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../hardware-components/02-memory.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../instruction-set/index.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
